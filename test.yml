---
- name: Run Angular Tests
  hosts: buildserver
  become: yes
  gather_facts: no

  vars:
    project_dir: "{{ project_dir | default('/tmp/angular-app') }}"

  tasks:
    - name: Ensure dependencies are installed
      shell: npm install
      args:
        chdir: "{{ project_dir }}"

    - name: Install Google Chrome stable
      become: yes
      shell: |
        if ! command -v google-chrome &> /dev/null; then
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
          apt-get update
          apt-get install -y google-chrome-stable
        fi
      args:
        executable: /bin/bash

    - name: Run Angular unit tests (headless)
      shell: npm test --watch=false
      args:
        chdir: "{{ project_dir }}"
